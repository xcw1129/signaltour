# 短时傅立叶变换与时频图

## 1. 提出背景

### 1.1 傅里叶变换不足

傅里叶变换的基本思想，是将信号表达为一系列三角函数（共轭旋转复向量）的和形式。通过傅里叶变换可以将时域信号转换到频域，从而得到信号中特定频率成分的信息。而因为频率是进行故障诊断的重要特征，因此傅里叶变换作为机械设备状态监测的基本信号处理方法而得到极广泛应用，并衍生了一系列分析方法如频谱分析、功率谱分析和倒谱分析等。傅里叶变换的表达式和离散形式如下所示，

$$
X(f)=\int_{-\infty}^{+\infty}{x(t)\cdot e^{-2\pi ftj}dt}=<x(t),(e^{2\pi ftj})^*>\\
X[k]=\sum_{n=0}^{N}{x[n]\cdot e^{\frac{-2\pi knj}{N}}}
$$
从式中可以看出，傅里叶变换要求信号沿着整个时间轴进行积分，得到特定频率成分信息。并且从内积形式可以发现傅里叶变换的等效基函数——$e^{2\pi ftj}$，为时间上无限延伸的平稳成分。而现实中随处存在频率成分随时间变化的信号如人声信号，以及机械设备因工况变化等产生的非平稳信号。

因此，傅里叶变换在应用时的最大不足：**完全忽略信号的时变信息，从而丧失了分析非平稳信号的能力**。如下图所示，傅里叶频谱中不同时刻的频率成分相互涂抹，无法体现频率成分随时间变化的特性。

### 1.2 STFT的改进思路

​	STFT的基本思想是将整段信号波形使用短时窗分割成多段，并对每段分别应用傅里叶变换。即通过信号分段以牺牲一定频率分辨率为前提，将变换结果变为$t、f$的函数，获得信号能量或功率在时间-频率上的二维分布。

## 2. 原理公式

### 2.1 STFT变换式

​	假设对信号$x(t)$在$t=\tau_0$局部直接截取一段时间长度，表示为
$$
x_{\tau_0}(t)=x(t)\cdot w(t-\tau_0)
$$
其中$w(t)$为截断所使用的窗函数，如$w(t)=1, T_w/2\le t<T_w/2$，此时$T$为该局部的时间长度。$w(t-\tau_0)$表示将窗沿时间轴移动，以在特定时刻截断$x(t)$。为了分析该局部$x_{\tau}(t)$的频率成分，对其进行傅里叶变换有
$$
\begin{align}S_{\tau_0}(f)&=\int_{-\infty}^{+\infty}{x_{\tau_0}(t)\cdot e^{-2\pi ftj}dt}\\&=\int_{-\infty}^{+\infty}{x(t)w(t-\tau_0)\cdot e^{-2\pi ftj}dt}\end{align}
$$
​	在此基础上同理可获得$\tau=\tau_1,\ \tau_2,\ \tau_3\cdots$时刻$x(t)$局部的频谱，并将结果并列表达为$f、\tau$的函数即为STFT变换。通常取结果的幅值平方$|S(f,\tau)|^2$作为信号功率，通过谱图（spectrogram）在时间-频率轴上进行展示。

​	此外，STFT变换式$S(f,\tau)=\int_{-\infty}^{+\infty}{x(t)w(t-\tau)\cdot e^{-2\pi ftj}dt}=<x(t),w(t-\tau)e^{2\pi ftj}>$，与傅里叶变换相似，$w(t-\tau)e^{2\pi ftj}$可看作基函数或基本信号（elementary signal）。而STFT可看作将信号分解为一系列不同时间、频率尺度的基本信号的和，并可以在二维平面展示分解结果。

### 2.2 滤波器特性

观察STFT的变换表达式
$$
S(f,\tau)=\int_{-\infty}^{+\infty}{x(t)w(t-\tau)e^{-2\pi ftj}dt}
$$
来源于对信号局部进行傅里叶变换。当把$S(f,\tau)$看作频率$f$的函数，其幅值平方$|S(f,\tau)|^{2}$可看做信号在时间$\tau$附近的功率谱。

当把$S(f,\tau)$看作时间$\tau$的函数，当$f=f_0$时，有
$$
x(t)e^{-2\pi f_0tj}=F^{-1}\{X(f+f_0)\}=x_{f_0}(t)
$$
即对$x(t)$进行频移操作,频移后的解析信号记为$x_{f_0}(t)$。此时有
$$
\begin{align}S(f_0,\tau)&=\int_{-\infty}^{+\infty}{x(t)w(t-\tau)e^{-2\pi f_0tj}dt}\\&=\int_{-\infty}^{+\infty}{x_{f_0}(t)w(t-\tau)dt}\\&=x_{f_0}(t)*w(-t)\\&=F^{-1}\{X(f+f_0)\cdot W(f)\}\end{align}
$$
即$S(f,t)$可看作信号带通滤波后的时域复包络，其中$e^{-2\pi ftj}$为频域因子，$w(t)$为低通滤波器。计算谱峭度的最常用方法即通过STFT的该特性对时域信号按频率分解
$$
SK(f)=\frac{<|S(f,t)|^4>}{<|S(f,t)|^2>^2}-2
$$

### 2.3 时频分辨率关系

当考虑到STFT分别在时域和频域上区分信号成分的能力时，即为时、频分辨率问题。

联系STFT的滤波器特性，其频谱的分辨率显然与滤波器的带宽有关。如果两个正弦波之间的频率间隔大于带宽$\Delta f$，那么这两个正弦波就能在二维谱图的不同位置得以区分。给定窗函数$w(t)$和频谱$W(f)$，其带宽可按下式计算
$$
\Delta f=\sqrt \frac{\int f^2|W(f)|^2df}{\int{|W(f)|^2df}}
$$
同样地，窗函数沿时间轴滑动截取信号。若信号时域中两个相邻成分如脉冲的间隔，大于窗函数时域带宽，则能够被区分。窗函数时域带宽计算如下
$$
\Delta t=\sqrt \frac{\int t^2|w(t)|^2dt}{\int{|w(t)|^2dt}}
$$
联系Parseval能量守恒关系
$$
\int_{-\infty}^{\infty} |w(t)|^2 dt = \int_{-\infty}^{\infty} |\hat{W}(f)|^2 df
$$
可得到分辨率的不确定性原理
$$
\Delta t\Delta f \ge\frac{1}{4\pi}
$$
即STFT的时间分辨率和频率分辨率不能同时提高。若想要提高时间分辨率，只能牺牲频率分辨率来减小窗函数宽度；反之亦然。当且仅当采用了高斯窗函数，上述不等式取等号。

注意到窗函数在滑动截取过程中带宽保持不变，即在STFT结果的时频平面上分辨率均匀不变。

### 2.4 窗函数

#### 2.4.1 泄漏现象

​	在STFT过程中，当已从信号$x(t)$中截取出$x_{\tau}$，后续步骤即为DFT过程。由于截取时间长度$T_w$一般远小于信号长度，导致STFT的局部频谱间隔$\Delta f=1/T_w$大幅增大，导致DFT过程的频谱泄露问题更为突出。**因此，STFT的窗函数选择，极大影响结果的有效性**。

​	下图说明了STFT中DFT过程泄露现象产生的原因：针对$x(t)$中某一频率成分$X(f_0)\cdot e^{2\pi f_0tj}$。若在任意时刻$t=\tau$左右截取$T_w$，且不加窗（即矩形窗，其频谱如下图虚线），获得$x_{\tau}(t)$。单一频率成分与窗函数频谱叠加，中心频率为$f_0$，则当且仅当为整周期截取，此时$f_0=n\cdot \Delta f=n/T_w$，即$T_w=n\cdot T_0$时，窗函数频谱中心$f_0$与DFT离散谱线重叠，主峰幅值不变，旁瓣幅值为零，此时无泄漏现象。

​	实际计算时无法保证恰好为整周期截取，例如有$T_w=n\cdot T_0+T_0/2$，此时窗函数频谱与DFT离散谱线错位，产生严重的泄漏现象:

- 真实频峰消失，产生幅值下降的旁峰
- 产生一系列宽带分布的，呈幅值衰减趋势的旁波带

​	以上产生泄漏现象的原因说明，合适的窗函数，其频谱形状应追求：

- 尽量小的旁瓣（降低泄漏成分的高度）
- 尽量大的旁瓣衰减率（缩小泄漏带宽）
- 尽量窄的主峰（减少宽带噪声）
- 尽量平的主峰顶（减小谱峰幅值衰减）

一般无法将所有指标都做到最优，尤其第三点与第四点通常矛盾，所以窗函数应根据具体需求进行选择。以下为常用窗的指标

综合来看Hanning窗适用于一般情况，特殊情况如测量谱峰高度可采用平顶窗，TSA中可采用矩形窗，等。

#### 2.4.2 幅值缩放

下图为各种常用窗函数的单位高度时域波形和幅值一致缩放后的频谱。通过观察一般窗函数波形，可得到**加窗的直观作用为衰减截取信号，防止DFT过程出现端点跳变。**因此窗函数一般有两边衰减的趋势。

若计算STFT的幅值谱$|S|$，使用单位高度窗函数。由于窗函数的两边衰减趋势，会使得截取信号$x_{\tau_0}(t)$的平均功率下降。并且由于此时窗函数频谱的零频值小于一，$|S|$一般小于真实幅值。例如使用单位Hanning窗时，由于其零频值为0.5，$|S|$幅值减小到不加窗时的1/2。为了能在STFT幅值谱中直接观察离散频率成分的真实幅值，一般对|S|进行幅值一致缩放，缩放系数
$$
s_A=\frac{1}{\frac{1}{T_w}\int{w(t)dt}}=\frac{1}{\frac{1}{N_w}\sum_{}{w[n]}}
$$
若计算STFT的功率谱$|S|^2$，此时若仍采用幅值一致缩放，则额外的旁波带会产生额外功率，使得时频域的能量一致条件不被满足。此时一般对$|S|^2$进行功率一致缩放，缩放系数
$$
s_P=\frac{1}{\frac{1}{T_w}\int{w^2(t)dt}}=\frac{1}{\frac{1}{N_w}\sum{(w[n])^2}}
$$
若根据幅值一致缩放后的$|S|$计算$|S|^2$，则功率一致缩放系数
$$
s'_P=\frac{(s_A)^2}{s_P}=\frac{(\frac{1}{T_w}\int{w(t)dt})^2}{\frac{1}{T_w}\int{w^2(t)dt}}=\frac{(\frac{1}{N_w}\sum_{}{w[n]})^2}{\frac{1}{N_w}\sum{(w[n])^2}}
$$

### 2.5 ISTFT变换

STFT中通过沿时间轴滑动截取的窗函数，生成信号不同帧的频谱或功率谱，并组成二维时频平面。则ISTFT重构原始信号的步骤则为：

1. 判断时频数据是否满足重构条件
2. 对时间轴上每帧频谱单独进行IDFT
3. 组合帧信号，并去除窗函数影响

在离散形式下定义原始信号为$x[n]$，频谱为$X[k]$。经过STFT加窗得到$x_i[n]=x[n]w[n-iH]$，$H$为每帧直接的点数间隔nhop，其频谱为$X_i[k]$。若定义某帧频谱的IDFT的结果为$x_i'[n]$，则叠加所有$x_i'[n]$
$$
\begin{aligned}
\sum x'_{i}[n]& =\sum_{t}\left(\frac{1}{N} \sum_{k=0}^{N-1} X_{i}[k] e^{2 \pi j k(n-iH) / N}\right) \\
& =\sum x_{i}[n]\\
& =\sum x[n] w[n-iH]\\
& =x[n] \sum w(n-iH)\\
\to x[n]&=\frac{\sum x'_{i}(n)}{\sum w(n-iH)}
\end{aligned}
$$
为了使得ISTFT精确重构原始信号$x[n]$，要求$w[n]$满足一下条件：

- NOLA：$\sum_{i=0}^{m}{w(n-iH)}$在所有点处不为零
- COLA：$\sum_{i=0}^{m}{w(n-iH)}$所有点值相同

满足以上条件则$\sum IDFT\{X_i[k]\}=\sum x'_{i}[n]=x[n]$。若在计算$x'_i[n]$时与STFT采用相同的加窗操作得到$\hat x'_i[n]$，则
$$
x[n]=\frac{\sum \hat x'_{i}(n)}{\sum w^2(n-iH)}
$$
此时一般不要求窗函数$w[n]$满足COLA约束，只需对ISTFT结果进行归一化即可准确重构。且由于ISTFT过程采用加窗操作，重构信号更加稳定，且结果等价于Griffin-Lim最优估计。

---

**参考文献：**

[1] RANDALL R B. Basic Signal Processing Techniques [M]. Vibration–based Condition Monitoring. 2021: 63-121.

[2] GABOR D. Theory of communication [J]. Journal of the Institution of Electrical Engineers - Part I: General, 1946, 94: 429-441.

[3] RANDALL R B, ANTONI J. Rolling element bearing diagnostics—A tutorial [J]. Mechanical Systems and Signal Processing.

[4] JARDINE A K S, LIN D, BANJEVIC D. A review on machinery diagnostics and prognostics implementing condition-based maintenance [J]. Mechanical Systems and Signal Processing.

[5] 何正嘉, 訾艳阳, 张西宁. 现代信号处理及工程应用 [M].西安交通大学出版社

[6] [Signal Processing (scipy.signal) — SciPy v1.14.1 Manual](https://docs.scipy.org/doc/scipy/tutorial/signal.html#short-time-fourier-transform)

[7] [Invertibility of overlap-add processing (gauss256.github.io)](https://gauss256.github.io/blog/cola.html)

[8] D. Griffin, Jae Lim. Signal estimation from modified short-time Fourier transform [J]. IEEE Transactions on Acoustics, Speech, and Signal Processing.

